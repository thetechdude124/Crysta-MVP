{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.EstimatedDocumentCountOperation = void 0;\n\nconst operation_1 = require(\"./operation\");\n\nconst command_1 = require(\"./command\");\n\nconst utils_1 = require(\"../utils\");\n/** @internal */\n\n\nclass EstimatedDocumentCountOperation extends command_1.CommandOperation {\n  constructor(collection, options = {}) {\n    super(collection, options);\n    this.options = options;\n    this.collectionName = collection.collectionName;\n  }\n\n  execute(server, session, callback) {\n    if (utils_1.maxWireVersion(server) < 12) {\n      return this.executeLegacy(server, session, callback);\n    }\n\n    const pipeline = [{\n      $collStats: {\n        count: {}\n      }\n    }, {\n      $group: {\n        _id: 1,\n        n: {\n          $sum: '$count'\n        }\n      }\n    }];\n    const cmd = {\n      aggregate: this.collectionName,\n      pipeline,\n      cursor: {}\n    };\n\n    if (typeof this.options.maxTimeMS === 'number') {\n      cmd.maxTimeMS = this.options.maxTimeMS;\n    }\n\n    super.executeCommand(server, session, cmd, (err, response) => {\n      var _a, _b;\n\n      if (err && err.code !== 26) {\n        callback(err);\n        return;\n      }\n\n      callback(undefined, ((_b = (_a = response === null || response === void 0 ? void 0 : response.cursor) === null || _a === void 0 ? void 0 : _a.firstBatch[0]) === null || _b === void 0 ? void 0 : _b.n) || 0);\n    });\n  }\n\n  executeLegacy(server, session, callback) {\n    const cmd = {\n      count: this.collectionName\n    };\n\n    if (typeof this.options.maxTimeMS === 'number') {\n      cmd.maxTimeMS = this.options.maxTimeMS;\n    }\n\n    super.executeCommand(server, session, cmd, (err, response) => {\n      if (err) {\n        callback(err);\n        return;\n      }\n\n      callback(undefined, response.n || 0);\n    });\n  }\n\n}\n\nexports.EstimatedDocumentCountOperation = EstimatedDocumentCountOperation;\noperation_1.defineAspects(EstimatedDocumentCountOperation, [operation_1.Aspect.READ_OPERATION, operation_1.Aspect.RETRYABLE, operation_1.Aspect.CURSOR_CREATING]);","map":{"version":3,"sources":["../../src/operations/estimated_document_count.ts"],"names":[],"mappings":";;;;;;;AAAA,MAAA,WAAA,GAAA,OAAA,CAAA,aAAA,CAAA;;AACA,MAAA,SAAA,GAAA,OAAA,CAAA,WAAA,CAAA;;AACA,MAAA,OAAA,GAAA,OAAA,CAAA,UAAA,CAAA;AAiBA;;;AACA,MAAa,+BAAb,SAAqD,SAAA,CAAA,gBAArD,CAA6E;AAI3E,EAAA,WAAA,CAAY,UAAZ,EAAoC,OAAA,GAAyC,EAA7E,EAA+E;AAC7E,UAAM,UAAN,EAAkB,OAAlB;AACA,SAAK,OAAL,GAAe,OAAf;AACA,SAAK,cAAL,GAAsB,UAAU,CAAC,cAAjC;AACD;;AAED,EAAA,OAAO,CAAC,MAAD,EAAiB,OAAjB,EAAyC,QAAzC,EAAmE;AACxE,QAAI,OAAA,CAAA,cAAA,CAAe,MAAf,IAAyB,EAA7B,EAAiC;AAC/B,aAAO,KAAK,aAAL,CAAmB,MAAnB,EAA2B,OAA3B,EAAoC,QAApC,CAAP;AACD;;AACD,UAAM,QAAQ,GAAG,CAAC;AAAE,MAAA,UAAU,EAAE;AAAE,QAAA,KAAK,EAAE;AAAT;AAAd,KAAD,EAAgC;AAAE,MAAA,MAAM,EAAE;AAAE,QAAA,GAAG,EAAE,CAAP;AAAU,QAAA,CAAC,EAAE;AAAE,UAAA,IAAI,EAAE;AAAR;AAAb;AAAV,KAAhC,CAAjB;AAEA,UAAM,GAAG,GAAa;AAAE,MAAA,SAAS,EAAE,KAAK,cAAlB;AAAkC,MAAA,QAAlC;AAA4C,MAAA,MAAM,EAAE;AAApD,KAAtB;;AAEA,QAAI,OAAO,KAAK,OAAL,CAAa,SAApB,KAAkC,QAAtC,EAAgD;AAC9C,MAAA,GAAG,CAAC,SAAJ,GAAgB,KAAK,OAAL,CAAa,SAA7B;AACD;;AAED,UAAM,cAAN,CAAqB,MAArB,EAA6B,OAA7B,EAAsC,GAAtC,EAA2C,CAAC,GAAD,EAAM,QAAN,KAAkB;;;AAC3D,UAAI,GAAG,IAAK,GAAwB,CAAC,IAAzB,KAAkC,EAA9C,EAAkD;AAChD,QAAA,QAAQ,CAAC,GAAD,CAAR;AACA;AACD;;AAED,MAAA,QAAQ,CAAC,SAAD,EAAY,CAAA,CAAA,EAAA,GAAA,CAAA,EAAA,GAAA,QAAQ,KAAA,IAAR,IAAA,QAAQ,KAAA,KAAA,CAAR,GAAQ,KAAA,CAAR,GAAA,QAAQ,CAAE,MAAV,MAAgB,IAAhB,IAAgB,EAAA,KAAA,KAAA,CAAhB,GAAgB,KAAA,CAAhB,GAAgB,EAAA,CAAE,UAAF,CAAa,CAAb,CAAhB,MAA+B,IAA/B,IAA+B,EAAA,KAAA,KAAA,CAA/B,GAA+B,KAAA,CAA/B,GAA+B,EAAA,CAAE,CAAjC,KAAsC,CAAlD,CAAR;AACD,KAPD;AAQD;;AAED,EAAA,aAAa,CAAC,MAAD,EAAiB,OAAjB,EAAyC,QAAzC,EAAmE;AAC9E,UAAM,GAAG,GAAa;AAAE,MAAA,KAAK,EAAE,KAAK;AAAd,KAAtB;;AAEA,QAAI,OAAO,KAAK,OAAL,CAAa,SAApB,KAAkC,QAAtC,EAAgD;AAC9C,MAAA,GAAG,CAAC,SAAJ,GAAgB,KAAK,OAAL,CAAa,SAA7B;AACD;;AAED,UAAM,cAAN,CAAqB,MAArB,EAA6B,OAA7B,EAAsC,GAAtC,EAA2C,CAAC,GAAD,EAAM,QAAN,KAAkB;AAC3D,UAAI,GAAJ,EAAS;AACP,QAAA,QAAQ,CAAC,GAAD,CAAR;AACA;AACD;;AAED,MAAA,QAAQ,CAAC,SAAD,EAAY,QAAQ,CAAC,CAAT,IAAc,CAA1B,CAAR;AACD,KAPD;AAQD;;AA/C0E;;AAA7E,OAAA,CAAA,+BAAA,GAAA,+BAAA;AAkDA,WAAA,CAAA,aAAA,CAAc,+BAAd,EAA+C,CAC7C,WAAA,CAAA,MAAA,CAAO,cADsC,EAE7C,WAAA,CAAA,MAAA,CAAO,SAFsC,EAG7C,WAAA,CAAA,MAAA,CAAO,eAHsC,CAA/C","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.EstimatedDocumentCountOperation = void 0;\nconst operation_1 = require(\"./operation\");\nconst command_1 = require(\"./command\");\nconst utils_1 = require(\"../utils\");\n/** @internal */\nclass EstimatedDocumentCountOperation extends command_1.CommandOperation {\n    constructor(collection, options = {}) {\n        super(collection, options);\n        this.options = options;\n        this.collectionName = collection.collectionName;\n    }\n    execute(server, session, callback) {\n        if (utils_1.maxWireVersion(server) < 12) {\n            return this.executeLegacy(server, session, callback);\n        }\n        const pipeline = [{ $collStats: { count: {} } }, { $group: { _id: 1, n: { $sum: '$count' } } }];\n        const cmd = { aggregate: this.collectionName, pipeline, cursor: {} };\n        if (typeof this.options.maxTimeMS === 'number') {\n            cmd.maxTimeMS = this.options.maxTimeMS;\n        }\n        super.executeCommand(server, session, cmd, (err, response) => {\n            var _a, _b;\n            if (err && err.code !== 26) {\n                callback(err);\n                return;\n            }\n            callback(undefined, ((_b = (_a = response === null || response === void 0 ? void 0 : response.cursor) === null || _a === void 0 ? void 0 : _a.firstBatch[0]) === null || _b === void 0 ? void 0 : _b.n) || 0);\n        });\n    }\n    executeLegacy(server, session, callback) {\n        const cmd = { count: this.collectionName };\n        if (typeof this.options.maxTimeMS === 'number') {\n            cmd.maxTimeMS = this.options.maxTimeMS;\n        }\n        super.executeCommand(server, session, cmd, (err, response) => {\n            if (err) {\n                callback(err);\n                return;\n            }\n            callback(undefined, response.n || 0);\n        });\n    }\n}\nexports.EstimatedDocumentCountOperation = EstimatedDocumentCountOperation;\noperation_1.defineAspects(EstimatedDocumentCountOperation, [\n    operation_1.Aspect.READ_OPERATION,\n    operation_1.Aspect.RETRYABLE,\n    operation_1.Aspect.CURSOR_CREATING\n]);\n//# sourceMappingURL=estimated_document_count.js.map"]},"metadata":{},"sourceType":"script"}