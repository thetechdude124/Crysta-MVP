{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.makeDeleteStatement = exports.DeleteManyOperation = exports.DeleteOneOperation = exports.DeleteOperation = void 0;\n\nconst operation_1 = require(\"./operation\");\n\nconst command_1 = require(\"./command\");\n\nconst utils_1 = require(\"../utils\");\n\nconst error_1 = require(\"../error\");\n/** @internal */\n\n\nclass DeleteOperation extends command_1.CommandOperation {\n  constructor(ns, statements, options) {\n    super(undefined, options);\n    this.options = options;\n    this.ns = ns;\n    this.statements = statements;\n  }\n\n  get canRetryWrite() {\n    if (super.canRetryWrite === false) {\n      return false;\n    }\n\n    return this.statements.every(op => op.limit != null ? op.limit > 0 : true);\n  }\n\n  execute(server, session, callback) {\n    var _a;\n\n    const options = (_a = this.options) !== null && _a !== void 0 ? _a : {};\n    const ordered = typeof options.ordered === 'boolean' ? options.ordered : true;\n    const command = {\n      delete: this.ns.collection,\n      deletes: this.statements,\n      ordered\n    };\n\n    if (options.let) {\n      command.let = options.let;\n    }\n\n    if (options.explain != null && utils_1.maxWireVersion(server) < 3) {\n      return callback ? callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support explain on delete`)) : undefined;\n    }\n\n    const unacknowledgedWrite = this.writeConcern && this.writeConcern.w === 0;\n\n    if (unacknowledgedWrite || utils_1.maxWireVersion(server) < 5) {\n      if (this.statements.find(o => o.hint)) {\n        callback(new error_1.MongoCompatibilityError(`Servers < 3.4 do not support hint on delete`));\n        return;\n      }\n    }\n\n    const statementWithCollation = this.statements.find(statement => !!statement.collation);\n\n    if (statementWithCollation && utils_1.collationNotSupported(server, statementWithCollation)) {\n      callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support collation`));\n      return;\n    }\n\n    super.executeCommand(server, session, command, callback);\n  }\n\n}\n\nexports.DeleteOperation = DeleteOperation;\n\nclass DeleteOneOperation extends DeleteOperation {\n  constructor(collection, filter, options) {\n    super(collection.s.namespace, [makeDeleteStatement(filter, { ...options,\n      limit: 1\n    })], options);\n  }\n\n  execute(server, session, callback) {\n    super.execute(server, session, (err, res) => {\n      var _a, _b;\n\n      if (err || res == null) return callback(err);\n      if (res.code) return callback(new error_1.MongoServerError(res));\n      if (res.writeErrors) return callback(new error_1.MongoServerError(res.writeErrors[0]));\n      if (this.explain) return callback(undefined, res);\n      callback(undefined, {\n        acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n        deletedCount: res.n\n      });\n    });\n  }\n\n}\n\nexports.DeleteOneOperation = DeleteOneOperation;\n\nclass DeleteManyOperation extends DeleteOperation {\n  constructor(collection, filter, options) {\n    super(collection.s.namespace, [makeDeleteStatement(filter, options)], options);\n  }\n\n  execute(server, session, callback) {\n    super.execute(server, session, (err, res) => {\n      var _a, _b;\n\n      if (err || res == null) return callback(err);\n      if (res.code) return callback(new error_1.MongoServerError(res));\n      if (res.writeErrors) return callback(new error_1.MongoServerError(res.writeErrors[0]));\n      if (this.explain) return callback(undefined, res);\n      callback(undefined, {\n        acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n        deletedCount: res.n\n      });\n    });\n  }\n\n}\n\nexports.DeleteManyOperation = DeleteManyOperation;\n\nfunction makeDeleteStatement(filter, options) {\n  const op = {\n    q: filter,\n    limit: typeof options.limit === 'number' ? options.limit : 0\n  };\n\n  if (options.single === true) {\n    op.limit = 1;\n  }\n\n  if (options.collation) {\n    op.collation = options.collation;\n  }\n\n  if (options.hint) {\n    op.hint = options.hint;\n  }\n\n  if (options.comment) {\n    op.comment = options.comment;\n  }\n\n  return op;\n}\n\nexports.makeDeleteStatement = makeDeleteStatement;\noperation_1.defineAspects(DeleteOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION]);\noperation_1.defineAspects(DeleteOneOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION, operation_1.Aspect.EXPLAINABLE, operation_1.Aspect.SKIP_COLLATION]);\noperation_1.defineAspects(DeleteManyOperation, [operation_1.Aspect.WRITE_OPERATION, operation_1.Aspect.EXPLAINABLE, operation_1.Aspect.SKIP_COLLATION]);","map":{"version":3,"sources":["../../src/operations/delete.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.makeDeleteStatement = exports.DeleteManyOperation = exports.DeleteOneOperation = exports.DeleteOperation = void 0;\nconst operation_1 = require(\"./operation\");\nconst command_1 = require(\"./command\");\nconst utils_1 = require(\"../utils\");\nconst error_1 = require(\"../error\");\n/** @internal */\nclass DeleteOperation extends command_1.CommandOperation {\n    constructor(ns, statements, options) {\n        super(undefined, options);\n        this.options = options;\n        this.ns = ns;\n        this.statements = statements;\n    }\n    get canRetryWrite() {\n        if (super.canRetryWrite === false) {\n            return false;\n        }\n        return this.statements.every(op => (op.limit != null ? op.limit > 0 : true));\n    }\n    execute(server, session, callback) {\n        var _a;\n        const options = (_a = this.options) !== null && _a !== void 0 ? _a : {};\n        const ordered = typeof options.ordered === 'boolean' ? options.ordered : true;\n        const command = {\n            delete: this.ns.collection,\n            deletes: this.statements,\n            ordered\n        };\n        if (options.let) {\n            command.let = options.let;\n        }\n        if (options.explain != null && utils_1.maxWireVersion(server) < 3) {\n            return callback\n                ? callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support explain on delete`))\n                : undefined;\n        }\n        const unacknowledgedWrite = this.writeConcern && this.writeConcern.w === 0;\n        if (unacknowledgedWrite || utils_1.maxWireVersion(server) < 5) {\n            if (this.statements.find((o) => o.hint)) {\n                callback(new error_1.MongoCompatibilityError(`Servers < 3.4 do not support hint on delete`));\n                return;\n            }\n        }\n        const statementWithCollation = this.statements.find(statement => !!statement.collation);\n        if (statementWithCollation && utils_1.collationNotSupported(server, statementWithCollation)) {\n            callback(new error_1.MongoCompatibilityError(`Server ${server.name} does not support collation`));\n            return;\n        }\n        super.executeCommand(server, session, command, callback);\n    }\n}\nexports.DeleteOperation = DeleteOperation;\nclass DeleteOneOperation extends DeleteOperation {\n    constructor(collection, filter, options) {\n        super(collection.s.namespace, [makeDeleteStatement(filter, { ...options, limit: 1 })], options);\n    }\n    execute(server, session, callback) {\n        super.execute(server, session, (err, res) => {\n            var _a, _b;\n            if (err || res == null)\n                return callback(err);\n            if (res.code)\n                return callback(new error_1.MongoServerError(res));\n            if (res.writeErrors)\n                return callback(new error_1.MongoServerError(res.writeErrors[0]));\n            if (this.explain)\n                return callback(undefined, res);\n            callback(undefined, {\n                acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n                deletedCount: res.n\n            });\n        });\n    }\n}\nexports.DeleteOneOperation = DeleteOneOperation;\nclass DeleteManyOperation extends DeleteOperation {\n    constructor(collection, filter, options) {\n        super(collection.s.namespace, [makeDeleteStatement(filter, options)], options);\n    }\n    execute(server, session, callback) {\n        super.execute(server, session, (err, res) => {\n            var _a, _b;\n            if (err || res == null)\n                return callback(err);\n            if (res.code)\n                return callback(new error_1.MongoServerError(res));\n            if (res.writeErrors)\n                return callback(new error_1.MongoServerError(res.writeErrors[0]));\n            if (this.explain)\n                return callback(undefined, res);\n            callback(undefined, {\n                acknowledged: (_b = ((_a = this.writeConcern) === null || _a === void 0 ? void 0 : _a.w) !== 0) !== null && _b !== void 0 ? _b : true,\n                deletedCount: res.n\n            });\n        });\n    }\n}\nexports.DeleteManyOperation = DeleteManyOperation;\nfunction makeDeleteStatement(filter, options) {\n    const op = {\n        q: filter,\n        limit: typeof options.limit === 'number' ? options.limit : 0\n    };\n    if (options.single === true) {\n        op.limit = 1;\n    }\n    if (options.collation) {\n        op.collation = options.collation;\n    }\n    if (options.hint) {\n        op.hint = options.hint;\n    }\n    if (options.comment) {\n        op.comment = options.comment;\n    }\n    return op;\n}\nexports.makeDeleteStatement = makeDeleteStatement;\noperation_1.defineAspects(DeleteOperation, [operation_1.Aspect.RETRYABLE, operation_1.Aspect.WRITE_OPERATION]);\noperation_1.defineAspects(DeleteOneOperation, [\n    operation_1.Aspect.RETRYABLE,\n    operation_1.Aspect.WRITE_OPERATION,\n    operation_1.Aspect.EXPLAINABLE,\n    operation_1.Aspect.SKIP_COLLATION\n]);\noperation_1.defineAspects(DeleteManyOperation, [\n    operation_1.Aspect.WRITE_OPERATION,\n    operation_1.Aspect.EXPLAINABLE,\n    operation_1.Aspect.SKIP_COLLATION\n]);\n//# sourceMappingURL=delete.js.map"]},"metadata":{},"sourceType":"script"}