{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.compareTopologyVersion = exports.parseServerType = exports.ServerDescription = void 0;\n\nconst utils_1 = require(\"../utils\");\n\nconst common_1 = require(\"./common\");\n\nconst bson_1 = require(\"../bson\");\n\nconst WRITABLE_SERVER_TYPES = new Set([common_1.ServerType.RSPrimary, common_1.ServerType.Standalone, common_1.ServerType.Mongos, common_1.ServerType.LoadBalancer]);\nconst DATA_BEARING_SERVER_TYPES = new Set([common_1.ServerType.RSPrimary, common_1.ServerType.RSSecondary, common_1.ServerType.Mongos, common_1.ServerType.Standalone, common_1.ServerType.LoadBalancer]);\n/**\n * The client's view of a single server, based on the most recent ismaster outcome.\n *\n * Internal type, not meant to be directly instantiated\n * @public\n */\n\nclass ServerDescription {\n  /**\n   * Create a ServerDescription\n   * @internal\n   *\n   * @param address - The address of the server\n   * @param ismaster - An optional ismaster response for this server\n   */\n  constructor(address, ismaster, options) {\n    var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m;\n\n    if (typeof address === 'string') {\n      this._hostAddress = new utils_1.HostAddress(address);\n      this.address = this._hostAddress.toString();\n    } else {\n      this._hostAddress = address;\n      this.address = this._hostAddress.toString();\n    }\n\n    this.type = parseServerType(ismaster, options);\n    this.hosts = (_b = (_a = ismaster === null || ismaster === void 0 ? void 0 : ismaster.hosts) === null || _a === void 0 ? void 0 : _a.map(host => host.toLowerCase())) !== null && _b !== void 0 ? _b : [];\n    this.passives = (_d = (_c = ismaster === null || ismaster === void 0 ? void 0 : ismaster.passives) === null || _c === void 0 ? void 0 : _c.map(host => host.toLowerCase())) !== null && _d !== void 0 ? _d : [];\n    this.arbiters = (_f = (_e = ismaster === null || ismaster === void 0 ? void 0 : ismaster.arbiters) === null || _e === void 0 ? void 0 : _e.map(host => host.toLowerCase())) !== null && _f !== void 0 ? _f : [];\n    this.tags = (_g = ismaster === null || ismaster === void 0 ? void 0 : ismaster.tags) !== null && _g !== void 0 ? _g : {};\n    this.minWireVersion = (_h = ismaster === null || ismaster === void 0 ? void 0 : ismaster.minWireVersion) !== null && _h !== void 0 ? _h : 0;\n    this.maxWireVersion = (_j = ismaster === null || ismaster === void 0 ? void 0 : ismaster.maxWireVersion) !== null && _j !== void 0 ? _j : 0;\n    this.roundTripTime = (_k = options === null || options === void 0 ? void 0 : options.roundTripTime) !== null && _k !== void 0 ? _k : -1;\n    this.lastUpdateTime = utils_1.now();\n    this.lastWriteDate = (_m = (_l = ismaster === null || ismaster === void 0 ? void 0 : ismaster.lastWrite) === null || _l === void 0 ? void 0 : _l.lastWriteDate) !== null && _m !== void 0 ? _m : 0;\n\n    if (options === null || options === void 0 ? void 0 : options.topologyVersion) {\n      this.topologyVersion = options.topologyVersion;\n    } else if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.topologyVersion) {\n      this.topologyVersion = ismaster.topologyVersion;\n    }\n\n    if (options === null || options === void 0 ? void 0 : options.error) {\n      this.error = options.error;\n    }\n\n    if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.primary) {\n      this.primary = ismaster.primary;\n    }\n\n    if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.me) {\n      this.me = ismaster.me.toLowerCase();\n    }\n\n    if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.setName) {\n      this.setName = ismaster.setName;\n    }\n\n    if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.setVersion) {\n      this.setVersion = ismaster.setVersion;\n    }\n\n    if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.electionId) {\n      this.electionId = ismaster.electionId;\n    }\n\n    if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.logicalSessionTimeoutMinutes) {\n      this.logicalSessionTimeoutMinutes = ismaster.logicalSessionTimeoutMinutes;\n    }\n\n    if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.$clusterTime) {\n      this.$clusterTime = ismaster.$clusterTime;\n    }\n  }\n\n  get hostAddress() {\n    if (this._hostAddress) return this._hostAddress;else return new utils_1.HostAddress(this.address);\n  }\n\n  get allHosts() {\n    return this.hosts.concat(this.arbiters).concat(this.passives);\n  }\n  /** Is this server available for reads*/\n\n\n  get isReadable() {\n    return this.type === common_1.ServerType.RSSecondary || this.isWritable;\n  }\n  /** Is this server data bearing */\n\n\n  get isDataBearing() {\n    return DATA_BEARING_SERVER_TYPES.has(this.type);\n  }\n  /** Is this server available for writes */\n\n\n  get isWritable() {\n    return WRITABLE_SERVER_TYPES.has(this.type);\n  }\n\n  get host() {\n    const chopLength = `:${this.port}`.length;\n    return this.address.slice(0, -chopLength);\n  }\n\n  get port() {\n    const port = this.address.split(':').pop();\n    return port ? Number.parseInt(port, 10) : 27017;\n  }\n  /**\n   * Determines if another `ServerDescription` is equal to this one per the rules defined\n   * in the {@link https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#serverdescription|SDAM spec}\n   */\n\n\n  equals(other) {\n    const topologyVersionsEqual = this.topologyVersion === other.topologyVersion || compareTopologyVersion(this.topologyVersion, other.topologyVersion) === 0;\n    const electionIdsEqual = this.electionId && other.electionId ? other.electionId && this.electionId.equals(other.electionId) : this.electionId === other.electionId;\n    return other != null && utils_1.errorStrictEqual(this.error, other.error) && this.type === other.type && this.minWireVersion === other.minWireVersion && utils_1.arrayStrictEqual(this.hosts, other.hosts) && tagsStrictEqual(this.tags, other.tags) && this.setName === other.setName && this.setVersion === other.setVersion && electionIdsEqual && this.primary === other.primary && this.logicalSessionTimeoutMinutes === other.logicalSessionTimeoutMinutes && topologyVersionsEqual;\n  }\n\n}\n\nexports.ServerDescription = ServerDescription; // Parses an `ismaster` message and determines the server type\n\nfunction parseServerType(ismaster, options) {\n  if (options === null || options === void 0 ? void 0 : options.loadBalanced) {\n    return common_1.ServerType.LoadBalancer;\n  }\n\n  if (!ismaster || !ismaster.ok) {\n    return common_1.ServerType.Unknown;\n  }\n\n  if (ismaster.isreplicaset) {\n    return common_1.ServerType.RSGhost;\n  }\n\n  if (ismaster.msg && ismaster.msg === 'isdbgrid') {\n    return common_1.ServerType.Mongos;\n  }\n\n  if (ismaster.setName) {\n    if (ismaster.hidden) {\n      return common_1.ServerType.RSOther;\n    } else if (ismaster.ismaster || ismaster.isWritablePrimary) {\n      return common_1.ServerType.RSPrimary;\n    } else if (ismaster.secondary) {\n      return common_1.ServerType.RSSecondary;\n    } else if (ismaster.arbiterOnly) {\n      return common_1.ServerType.RSArbiter;\n    } else {\n      return common_1.ServerType.RSOther;\n    }\n  }\n\n  return common_1.ServerType.Standalone;\n}\n\nexports.parseServerType = parseServerType;\n\nfunction tagsStrictEqual(tags, tags2) {\n  const tagsKeys = Object.keys(tags);\n  const tags2Keys = Object.keys(tags2);\n  return tagsKeys.length === tags2Keys.length && tagsKeys.every(key => tags2[key] === tags[key]);\n}\n/**\n * Compares two topology versions.\n *\n * @returns A negative number if `lhs` is older than `rhs`; positive if `lhs` is newer than `rhs`; 0 if they are equivalent.\n */\n\n\nfunction compareTopologyVersion(lhs, rhs) {\n  if (lhs == null || rhs == null) {\n    return -1;\n  }\n\n  if (lhs.processId.equals(rhs.processId)) {\n    // tests mock counter as just number, but in a real situation counter should always be a Long\n    const lhsCounter = bson_1.Long.isLong(lhs.counter) ? lhs.counter : bson_1.Long.fromNumber(lhs.counter);\n    const rhsCounter = bson_1.Long.isLong(rhs.counter) ? lhs.counter : bson_1.Long.fromNumber(rhs.counter);\n    return lhsCounter.compare(rhsCounter);\n  }\n\n  return -1;\n}\n\nexports.compareTopologyVersion = compareTopologyVersion;","map":{"version":3,"sources":["../../src/sdam/server_description.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.compareTopologyVersion = exports.parseServerType = exports.ServerDescription = void 0;\nconst utils_1 = require(\"../utils\");\nconst common_1 = require(\"./common\");\nconst bson_1 = require(\"../bson\");\nconst WRITABLE_SERVER_TYPES = new Set([\n    common_1.ServerType.RSPrimary,\n    common_1.ServerType.Standalone,\n    common_1.ServerType.Mongos,\n    common_1.ServerType.LoadBalancer\n]);\nconst DATA_BEARING_SERVER_TYPES = new Set([\n    common_1.ServerType.RSPrimary,\n    common_1.ServerType.RSSecondary,\n    common_1.ServerType.Mongos,\n    common_1.ServerType.Standalone,\n    common_1.ServerType.LoadBalancer\n]);\n/**\n * The client's view of a single server, based on the most recent ismaster outcome.\n *\n * Internal type, not meant to be directly instantiated\n * @public\n */\nclass ServerDescription {\n    /**\n     * Create a ServerDescription\n     * @internal\n     *\n     * @param address - The address of the server\n     * @param ismaster - An optional ismaster response for this server\n     */\n    constructor(address, ismaster, options) {\n        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m;\n        if (typeof address === 'string') {\n            this._hostAddress = new utils_1.HostAddress(address);\n            this.address = this._hostAddress.toString();\n        }\n        else {\n            this._hostAddress = address;\n            this.address = this._hostAddress.toString();\n        }\n        this.type = parseServerType(ismaster, options);\n        this.hosts = (_b = (_a = ismaster === null || ismaster === void 0 ? void 0 : ismaster.hosts) === null || _a === void 0 ? void 0 : _a.map((host) => host.toLowerCase())) !== null && _b !== void 0 ? _b : [];\n        this.passives = (_d = (_c = ismaster === null || ismaster === void 0 ? void 0 : ismaster.passives) === null || _c === void 0 ? void 0 : _c.map((host) => host.toLowerCase())) !== null && _d !== void 0 ? _d : [];\n        this.arbiters = (_f = (_e = ismaster === null || ismaster === void 0 ? void 0 : ismaster.arbiters) === null || _e === void 0 ? void 0 : _e.map((host) => host.toLowerCase())) !== null && _f !== void 0 ? _f : [];\n        this.tags = (_g = ismaster === null || ismaster === void 0 ? void 0 : ismaster.tags) !== null && _g !== void 0 ? _g : {};\n        this.minWireVersion = (_h = ismaster === null || ismaster === void 0 ? void 0 : ismaster.minWireVersion) !== null && _h !== void 0 ? _h : 0;\n        this.maxWireVersion = (_j = ismaster === null || ismaster === void 0 ? void 0 : ismaster.maxWireVersion) !== null && _j !== void 0 ? _j : 0;\n        this.roundTripTime = (_k = options === null || options === void 0 ? void 0 : options.roundTripTime) !== null && _k !== void 0 ? _k : -1;\n        this.lastUpdateTime = utils_1.now();\n        this.lastWriteDate = (_m = (_l = ismaster === null || ismaster === void 0 ? void 0 : ismaster.lastWrite) === null || _l === void 0 ? void 0 : _l.lastWriteDate) !== null && _m !== void 0 ? _m : 0;\n        if (options === null || options === void 0 ? void 0 : options.topologyVersion) {\n            this.topologyVersion = options.topologyVersion;\n        }\n        else if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.topologyVersion) {\n            this.topologyVersion = ismaster.topologyVersion;\n        }\n        if (options === null || options === void 0 ? void 0 : options.error) {\n            this.error = options.error;\n        }\n        if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.primary) {\n            this.primary = ismaster.primary;\n        }\n        if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.me) {\n            this.me = ismaster.me.toLowerCase();\n        }\n        if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.setName) {\n            this.setName = ismaster.setName;\n        }\n        if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.setVersion) {\n            this.setVersion = ismaster.setVersion;\n        }\n        if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.electionId) {\n            this.electionId = ismaster.electionId;\n        }\n        if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.logicalSessionTimeoutMinutes) {\n            this.logicalSessionTimeoutMinutes = ismaster.logicalSessionTimeoutMinutes;\n        }\n        if (ismaster === null || ismaster === void 0 ? void 0 : ismaster.$clusterTime) {\n            this.$clusterTime = ismaster.$clusterTime;\n        }\n    }\n    get hostAddress() {\n        if (this._hostAddress)\n            return this._hostAddress;\n        else\n            return new utils_1.HostAddress(this.address);\n    }\n    get allHosts() {\n        return this.hosts.concat(this.arbiters).concat(this.passives);\n    }\n    /** Is this server available for reads*/\n    get isReadable() {\n        return this.type === common_1.ServerType.RSSecondary || this.isWritable;\n    }\n    /** Is this server data bearing */\n    get isDataBearing() {\n        return DATA_BEARING_SERVER_TYPES.has(this.type);\n    }\n    /** Is this server available for writes */\n    get isWritable() {\n        return WRITABLE_SERVER_TYPES.has(this.type);\n    }\n    get host() {\n        const chopLength = `:${this.port}`.length;\n        return this.address.slice(0, -chopLength);\n    }\n    get port() {\n        const port = this.address.split(':').pop();\n        return port ? Number.parseInt(port, 10) : 27017;\n    }\n    /**\n     * Determines if another `ServerDescription` is equal to this one per the rules defined\n     * in the {@link https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#serverdescription|SDAM spec}\n     */\n    equals(other) {\n        const topologyVersionsEqual = this.topologyVersion === other.topologyVersion ||\n            compareTopologyVersion(this.topologyVersion, other.topologyVersion) === 0;\n        const electionIdsEqual = this.electionId && other.electionId\n            ? other.electionId && this.electionId.equals(other.electionId)\n            : this.electionId === other.electionId;\n        return (other != null &&\n            utils_1.errorStrictEqual(this.error, other.error) &&\n            this.type === other.type &&\n            this.minWireVersion === other.minWireVersion &&\n            utils_1.arrayStrictEqual(this.hosts, other.hosts) &&\n            tagsStrictEqual(this.tags, other.tags) &&\n            this.setName === other.setName &&\n            this.setVersion === other.setVersion &&\n            electionIdsEqual &&\n            this.primary === other.primary &&\n            this.logicalSessionTimeoutMinutes === other.logicalSessionTimeoutMinutes &&\n            topologyVersionsEqual);\n    }\n}\nexports.ServerDescription = ServerDescription;\n// Parses an `ismaster` message and determines the server type\nfunction parseServerType(ismaster, options) {\n    if (options === null || options === void 0 ? void 0 : options.loadBalanced) {\n        return common_1.ServerType.LoadBalancer;\n    }\n    if (!ismaster || !ismaster.ok) {\n        return common_1.ServerType.Unknown;\n    }\n    if (ismaster.isreplicaset) {\n        return common_1.ServerType.RSGhost;\n    }\n    if (ismaster.msg && ismaster.msg === 'isdbgrid') {\n        return common_1.ServerType.Mongos;\n    }\n    if (ismaster.setName) {\n        if (ismaster.hidden) {\n            return common_1.ServerType.RSOther;\n        }\n        else if (ismaster.ismaster || ismaster.isWritablePrimary) {\n            return common_1.ServerType.RSPrimary;\n        }\n        else if (ismaster.secondary) {\n            return common_1.ServerType.RSSecondary;\n        }\n        else if (ismaster.arbiterOnly) {\n            return common_1.ServerType.RSArbiter;\n        }\n        else {\n            return common_1.ServerType.RSOther;\n        }\n    }\n    return common_1.ServerType.Standalone;\n}\nexports.parseServerType = parseServerType;\nfunction tagsStrictEqual(tags, tags2) {\n    const tagsKeys = Object.keys(tags);\n    const tags2Keys = Object.keys(tags2);\n    return (tagsKeys.length === tags2Keys.length &&\n        tagsKeys.every((key) => tags2[key] === tags[key]));\n}\n/**\n * Compares two topology versions.\n *\n * @returns A negative number if `lhs` is older than `rhs`; positive if `lhs` is newer than `rhs`; 0 if they are equivalent.\n */\nfunction compareTopologyVersion(lhs, rhs) {\n    if (lhs == null || rhs == null) {\n        return -1;\n    }\n    if (lhs.processId.equals(rhs.processId)) {\n        // tests mock counter as just number, but in a real situation counter should always be a Long\n        const lhsCounter = bson_1.Long.isLong(lhs.counter) ? lhs.counter : bson_1.Long.fromNumber(lhs.counter);\n        const rhsCounter = bson_1.Long.isLong(rhs.counter) ? lhs.counter : bson_1.Long.fromNumber(rhs.counter);\n        return lhsCounter.compare(rhsCounter);\n    }\n    return -1;\n}\nexports.compareTopologyVersion = compareTopologyVersion;\n//# sourceMappingURL=server_description.js.map"]},"metadata":{},"sourceType":"script"}